//==========================================================================
//文件名称：oled.c
//功能概要：OLED应用驱动程序源文件
//==========================================================================

#include "oled.h"
//使用可变参数
#include <stdarg.h>
//使用vasprintf
#include <stdio.h>
//使用free
#include <stdlib.h>

//当前数据/命令选择信号的电平
static uint8 current_dc_level;

//ASCII码字符集可显示部分(32-126)的字模数据，纵向取模，字节倒序;
//字符大小为8*16，前8字节为低页数据，后8字节为高页数据
static const uint8 char_lib[95][16] = {
{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //sp 0
{ 0x00, 0x00, 0x00, 0xF8, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x33, 0x30, 0x00, 0x00, 0x00 }, //!  1
{ 0x00, 0x10, 0x0C, 0x06, 0x10, 0x0C, 0x06, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //"  2
{ 0x40, 0xC0, 0x78, 0x40, 0xC0, 0x78, 0x40, 0x00,
  0x04, 0x3F, 0x04, 0x04, 0x3F, 0x04, 0x04, 0x00 }, //#  3
{ 0x00, 0x70, 0x88, 0xFC, 0x08, 0x30, 0x00, 0x00,
  0x00, 0x18, 0x20, 0xFF, 0x21, 0x1E, 0x00, 0x00 }, //$  4
{ 0xF0, 0x08, 0xF0, 0x00, 0xE0, 0x18, 0x00, 0x00,
  0x00, 0x21, 0x1C, 0x03, 0x1E, 0x21, 0x1E, 0x00 }, //%  5
{ 0x00, 0xF0, 0x08, 0x88, 0x70, 0x00, 0x00, 0x00,
  0x1E, 0x21, 0x23, 0x24, 0x19, 0x27, 0x21, 0x10 }, //&  6
{ 0x10, 0x16, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //'  7
{ 0x00, 0x00, 0x00, 0xE0, 0x18, 0x04, 0x02, 0x00,
  0x00, 0x00, 0x00, 0x07, 0x18, 0x20, 0x40, 0x00 }, //(  8
{ 0x00, 0x02, 0x04, 0x18, 0xE0, 0x00, 0x00, 0x00,
  0x00, 0x40, 0x20, 0x18, 0x07, 0x00, 0x00, 0x00 }, //)  9
{ 0x40, 0x40, 0x80, 0xF0, 0x80, 0x40, 0x40, 0x00,
  0x02, 0x02, 0x01, 0x0F, 0x01, 0x02, 0x02, 0x00 }, //* 10
{ 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00,
  0x01, 0x01, 0x01, 0x1F, 0x01, 0x01, 0x01, 0x00 }, //+ 11
{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x80, 0xB0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00 }, //, 12
{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01 }, //- 13
{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00 }, //. 14
{ 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x18, 0x04,
  0x00, 0x60, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00 }, /// 15
{ 0x00, 0xE0, 0x10, 0x08, 0x08, 0x10, 0xE0, 0x00,
  0x00, 0x0F, 0x10, 0x20, 0x20, 0x10, 0x0F, 0x00 }, //0 16
{ 0x00, 0x10, 0x10, 0xF8, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00 }, //1 17
{ 0x00, 0x70, 0x08, 0x08, 0x08, 0x88, 0x70, 0x00,
  0x00, 0x30, 0x28, 0x24, 0x22, 0x21, 0x30, 0x00 }, //2 18
{ 0x00, 0x30, 0x08, 0x88, 0x88, 0x48, 0x30, 0x00,
  0x00, 0x18, 0x20, 0x20, 0x20, 0x11, 0x0E, 0x00 }, //3 19
{ 0x00, 0x00, 0xC0, 0x20, 0x10, 0xF8, 0x00, 0x00,
  0x00, 0x07, 0x04, 0x24, 0x24, 0x3F, 0x24, 0x00 }, //4 20
{ 0x00, 0xF8, 0x08, 0x88, 0x88, 0x08, 0x08, 0x00,
  0x00, 0x19, 0x21, 0x20, 0x20, 0x11, 0x0E, 0x00 }, //5 21
{ 0x00, 0xE0, 0x10, 0x88, 0x88, 0x18, 0x00, 0x00,
  0x00, 0x0F, 0x11, 0x20, 0x20, 0x11, 0x0E, 0x00 }, //6 22
{ 0x00, 0x38, 0x08, 0x08, 0xC8, 0x38, 0x08, 0x00,
  0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00 }, //7 23
{ 0x00, 0x70, 0x88, 0x08, 0x08, 0x88, 0x70, 0x00,
  0x00, 0x1C, 0x22, 0x21, 0x21, 0x22, 0x1C, 0x00 }, //8 24
{ 0x00, 0xE0, 0x10, 0x08, 0x08, 0x10, 0xE0, 0x00,
  0x00, 0x00, 0x31, 0x22, 0x22, 0x11, 0x0F, 0x00 }, //9 25
{ 0x00, 0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00 }, //: 26
{ 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x80, 0x60, 0x00, 0x00, 0x00, 0x00 }, //; 27
{ 0x00, 0x00, 0x80, 0x40, 0x20, 0x10, 0x08, 0x00,
  0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00 }, //< 28
{ 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00,
  0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00 }, //= 29
{ 0x00, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00, 0x00,
  0x00, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00 }, //> 30
{ 0x00, 0x70, 0x48, 0x08, 0x08, 0x08, 0xF0, 0x00,
  0x00, 0x00, 0x00, 0x30, 0x36, 0x01, 0x00, 0x00 }, //? 31
{ 0xC0, 0x30, 0xC8, 0x28, 0xE8, 0x10, 0xE0, 0x00,
  0x07, 0x18, 0x27, 0x24, 0x23, 0x14, 0x0B, 0x00 }, //@ 32
{ 0x00, 0x00, 0xC0, 0x38, 0xE0, 0x00, 0x00, 0x00,
  0x20, 0x3C, 0x23, 0x02, 0x02, 0x27, 0x38, 0x20 }, //A 33
{ 0x08, 0xF8, 0x88, 0x88, 0x88, 0x70, 0x00, 0x00,
  0x20, 0x3F, 0x20, 0x20, 0x20, 0x11, 0x0E, 0x00 }, //B 34
{ 0xC0, 0x30, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00,
  0x07, 0x18, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00 }, //C 35
{ 0x08, 0xF8, 0x08, 0x08, 0x08, 0x10, 0xE0, 0x00,
  0x20, 0x3F, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x00 }, //D 36
{ 0x08, 0xF8, 0x88, 0x88, 0xE8, 0x08, 0x10, 0x00,
  0x20, 0x3F, 0x20, 0x20, 0x23, 0x20, 0x18, 0x00 }, //E 37
{ 0x08, 0xF8, 0x88, 0x88, 0xE8, 0x08, 0x10, 0x00,
  0x20, 0x3F, 0x20, 0x00, 0x03, 0x00, 0x00, 0x00 }, //F 38
{ 0xC0, 0x30, 0x08, 0x08, 0x08, 0x38, 0x00, 0x00,
  0x07, 0x18, 0x20, 0x20, 0x22, 0x1E, 0x02, 0x00 }, //G 39
{ 0x08, 0xF8, 0x08, 0x00, 0x00, 0x08, 0xF8, 0x08,
  0x20, 0x3F, 0x21, 0x01, 0x01, 0x21, 0x3F, 0x20 }, //H 40
{ 0x00, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x00, 0x00,
  0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00 }, //I 41
{ 0x00, 0x00, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x00,
  0xC0, 0x80, 0x80, 0x80, 0x7F, 0x00, 0x00, 0x00 }, //J 42
{ 0x08, 0xF8, 0x88, 0xC0, 0x28, 0x18, 0x08, 0x00,
  0x20, 0x3F, 0x20, 0x01, 0x26, 0x38, 0x20, 0x00 }, //K 43
{ 0x08, 0xF8, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x20, 0x3F, 0x20, 0x20, 0x20, 0x20, 0x30, 0x00 }, //L 44
{ 0x08, 0xF8, 0xF8, 0x00, 0xF8, 0xF8, 0x08, 0x00,
  0x20, 0x3F, 0x00, 0x3F, 0x00, 0x3F, 0x20, 0x00 }, //M 45
{ 0x08, 0xF8, 0x30, 0xC0, 0x00, 0x08, 0xF8, 0x08,
  0x20, 0x3F, 0x20, 0x00, 0x07, 0x18, 0x3F, 0x00 }, //N 46
{ 0xE0, 0x10, 0x08, 0x08, 0x08, 0x10, 0xE0, 0x00,
  0x0F, 0x10, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x00 }, //O 47
{ 0x08, 0xF8, 0x08, 0x08, 0x08, 0x08, 0xF0, 0x00,
  0x20, 0x3F, 0x21, 0x01, 0x01, 0x01, 0x00, 0x00 }, //P 48
{ 0xE0, 0x10, 0x08, 0x08, 0x08, 0x10, 0xE0, 0x00,
  0x0F, 0x18, 0x24, 0x24, 0x38, 0x50, 0x4F, 0x00 }, //Q 49
{ 0x08, 0xF8, 0x88, 0x88, 0x88, 0x88, 0x70, 0x00,
  0x20, 0x3F, 0x20, 0x00, 0x03, 0x0C, 0x30, 0x20 }, //R 50
{ 0x00, 0x70, 0x88, 0x08, 0x08, 0x08, 0x38, 0x00,
  0x00, 0x38, 0x20, 0x21, 0x21, 0x22, 0x1C, 0x00 }, //S 51
{ 0x18, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x18, 0x00,
  0x00, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x00, 0x00 }, //T 52
{ 0x08, 0xF8, 0x08, 0x00, 0x00, 0x08, 0xF8, 0x08,
  0x00, 0x1F, 0x20, 0x20, 0x20, 0x20, 0x1F, 0x00 }, //U 53
{ 0x08, 0x78, 0x88, 0x00, 0x00, 0xC8, 0x38, 0x08,
  0x00, 0x00, 0x07, 0x38, 0x0E, 0x01, 0x00, 0x00 }, //V 54
{ 0xF8, 0x08, 0x00, 0xF8, 0x00, 0x08, 0xF8, 0x00,
  0x03, 0x3C, 0x07, 0x00, 0x07, 0x3C, 0x03, 0x00 }, //W 55
{ 0x08, 0x18, 0x68, 0x80, 0x80, 0x68, 0x18, 0x08,
  0x20, 0x30, 0x2C, 0x03, 0x03, 0x2C, 0x30, 0x20 }, //X 56
{ 0x08, 0x38, 0xC8, 0x00, 0xC8, 0x38, 0x08, 0x00,
  0x00, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x00, 0x00 }, //Y 57
{ 0x10, 0x08, 0x08, 0x08, 0xC8, 0x38, 0x08, 0x00,
  0x20, 0x38, 0x26, 0x21, 0x20, 0x20, 0x18, 0x00 }, //Z 58
{ 0x00, 0x00, 0x00, 0xFE, 0x02, 0x02, 0x02, 0x00,
  0x00, 0x00, 0x00, 0x7F, 0x40, 0x40, 0x40, 0x00 }, //[ 59
{ 0x00, 0x0C, 0x30, 0xC0, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x06, 0x38, 0xC0, 0x00 }, //\ 60
{ 0x00, 0x02, 0x02, 0x02, 0xFE, 0x00, 0x00, 0x00,
  0x00, 0x40, 0x40, 0x40, 0x7F, 0x00, 0x00, 0x00 }, //] 61
{ 0x00, 0x00, 0x04, 0x02, 0x02, 0x02, 0x04, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //^ 62
{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80 }, //_ 63
{ 0x00, 0x02, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //` 64
{ 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00,
  0x00, 0x19, 0x24, 0x22, 0x22, 0x22, 0x3F, 0x20 }, //a 65
{ 0x08, 0xF8, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00,
  0x00, 0x3F, 0x11, 0x20, 0x20, 0x11, 0x0E, 0x00 }, //b 66
{ 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00,
  0x00, 0x0E, 0x11, 0x20, 0x20, 0x20, 0x11, 0x00 }, //c 67
{ 0x00, 0x00, 0x00, 0x80, 0x80, 0x88, 0xF8, 0x00,
  0x00, 0x0E, 0x11, 0x20, 0x20, 0x10, 0x3F, 0x20 }, //d 68
{ 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00,
  0x00, 0x1F, 0x22, 0x22, 0x22, 0x22, 0x13, 0x00 }, //e 69
{ 0x00, 0x80, 0x80, 0xF0, 0x88, 0x88, 0x88, 0x18,
  0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00 }, //f 70
{ 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
  0x00, 0x6B, 0x94, 0x94, 0x94, 0x93, 0x60, 0x00 }, //g 71
{ 0x08, 0xF8, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00,
  0x20, 0x3F, 0x21, 0x00, 0x00, 0x20, 0x3F, 0x20 }, //h 72
{ 0x00, 0x80, 0x98, 0x98, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00 }, //i 73
{ 0x00, 0x00, 0x00, 0x80, 0x98, 0x98, 0x00, 0x00,
  0x00, 0xC0, 0x80, 0x80, 0x80, 0x7F, 0x00, 0x00 }, //j 74
{ 0x08, 0xF8, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00,
  0x20, 0x3F, 0x24, 0x02, 0x2D, 0x30, 0x20, 0x00 }, //k 75
{ 0x00, 0x08, 0x08, 0xF8, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00 }, //l 76
{ 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
  0x20, 0x3F, 0x20, 0x00, 0x3F, 0x20, 0x00, 0x3F }, //m 77
{ 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00,
  0x20, 0x3F, 0x21, 0x00, 0x00, 0x20, 0x3F, 0x20 }, //n 78
{ 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00,
  0x00, 0x1F, 0x20, 0x20, 0x20, 0x20, 0x1F, 0x00 }, //o 79
{ 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00,
  0x80, 0xFF, 0xA1, 0x20, 0x20, 0x11, 0x0E, 0x00 }, //p 80
{ 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00,
  0x00, 0x0E, 0x11, 0x20, 0x20, 0xA0, 0xFF, 0x80 }, //q 81
{ 0x80, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x00,
  0x20, 0x20, 0x3F, 0x21, 0x20, 0x00, 0x01, 0x00 }, //r 82
{ 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
  0x00, 0x33, 0x24, 0x24, 0x24, 0x24, 0x19, 0x00 }, //s 83
{ 0x00, 0x80, 0x80, 0xE0, 0x80, 0x80, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x1F, 0x20, 0x20, 0x00, 0x00 }, //t 84
{ 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00,
  0x00, 0x1F, 0x20, 0x20, 0x20, 0x10, 0x3F, 0x20 }, //u 85
{ 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80,
  0x00, 0x01, 0x0E, 0x30, 0x08, 0x06, 0x01, 0x00 }, //v 86
{ 0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x80,
  0x0F, 0x30, 0x0C, 0x03, 0x0C, 0x30, 0x0F, 0x00 }, //w 87
{ 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x00,
  0x00, 0x20, 0x31, 0x2E, 0x0E, 0x31, 0x20, 0x00 }, //x 88
{ 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80,
  0x80, 0x81, 0x8E, 0x70, 0x18, 0x06, 0x01, 0x00 }, //y 89
{ 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
  0x00, 0x21, 0x30, 0x2C, 0x22, 0x21, 0x30, 0x00 }, //z 90
{ 0x00, 0x00, 0x00, 0x00, 0x80, 0x7C, 0x02, 0x02,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x40, 0x40 }, //{ 91
{ 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00 }, //| 92
{ 0x00, 0x02, 0x02, 0x7C, 0x80, 0x00, 0x00, 0x00,
  0x00, 0x40, 0x40, 0x3F, 0x00, 0x00, 0x00, 0x00 }, //} 93
{ 0x00, 0x06, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }  //~ 94
};

//==========================================================================
//函数名称: oled_write_cmd
//函数返回: 无
//参数说明: cmd:命令字节
//功能概要: 向OLED写一个字节命令，具体命令信息需查看芯片手册
//==========================================================================
static void oled_write_cmd(uint8 cmd) {
	//若当前不为命令信号电平
	if (current_dc_level != OLED_DC_CMD_LEVEL) {
		//设置为命令信号
		gpio_set(OLED_DC, OLED_DC_CMD_LEVEL);
		current_dc_level = OLED_DC_CMD_LEVEL;
	}
	//发送命令
	spi_master_send(OLED_SPI_MOD, OLED_SPI_CONFIG, OLED_SPI_CS, cmd,
	SPI_CONT_DISABLE);
}

//==========================================================================
//函数名称: oled_write_data
//函数返回: 无
//参数说明: data:数据字节
//功能概要: 向OLED写一个字节数据
//备注: 该字节数据用于填充当前所在页的所在列，SPI的位传输顺序为MSB时，高位填充高行，
//     OLED未开启反相显示时，1表示该像素亮，0表示该像素暗
//==========================================================================
void oled_write_data(uint8 data) {
	//若当前不为数据信号电平
	if (current_dc_level != OLED_DC_DATA_LEVEL) {
		//设置为数据信号
		gpio_set(OLED_DC, OLED_DC_DATA_LEVEL);
		current_dc_level = OLED_DC_DATA_LEVEL;
	}
	//发送数据
	spi_master_send(OLED_SPI_MOD, OLED_SPI_CONFIG, OLED_SPI_CS, data,
	SPI_CONT_DISABLE);
}

//==========================================================================
//函数名称: oled_init
//函数返回: 无
//参数说明: 无
//功能概要: 初始化OLED，相应配置在oled.h中
//备注: 屏幕左右、上下均反置，使能电荷泵，打开显示，且所有像素均为暗，
//     其余屏幕设置均为复位后设置
//==========================================================================
void oled_init() {
	//使能复位信号，并设置复位信号有效
	gpio_init(OLED_RST, GPIO_OUTPUT, OLED_RST_VALID_LEVEL);
	//使能数据/命令选择信号，并选择命令信号
	gpio_init(OLED_DC, GPIO_OUTPUT, OLED_DC_CMD_LEVEL);
	//当前数据/命令选择信号的电平为命令信号电平
	current_dc_level = OLED_DC_CMD_LEVEL;
	//按照设置初始化SPI模块
	spi_master_init(OLED_SPI_MOD, OLED_SPI_CONFIG, OLED_SPI_BAUD_SCALER,
	OLED_SPI_FORMAT, OLED_SPI_DATA_SIZE, OLED_SPI_BIT_ORDER,
	OLED_SPI_CSC_SCALER, OLED_SPI_ASC_SCALER, OLED_SPI_DT_SCALER);

	//复位信号需要保持有效至少3μs，这里初始化DC和SPI需要8μs左右，因此未添加延时
	//设置复位信号无效
	gpio_set(OLED_RST, OLED_RST_INVALID_LEVEL);

	//屏幕左右、上下均反置
	oled_set_remap(true, true);
	//使能电荷泵
	oled_set_charge_pump(true);
	//用0x00填充整个屏幕，即屏幕全暗
	oled_fill(0x00);
	//重置当前位置至0列0页
	oled_set_pos(0, 0);
	//打开显示
	oled_set_display_on(true);
}

//==========================================================================
//函数名称: oled_fill
//函数返回: 无
//参数说明: data:数据字节
//功能概要: 对整个屏幕填充同一个字节数据
//备注: 数据字节为0x00时，屏幕全暗，数据字节为0xFF时，屏幕全亮;
//     寻址方式需为按页寻址
//==========================================================================
void oled_fill(uint8 data) {
	uint8 i, j;	//游标

	//遍历每一页
	for (i = 0; i < OLED_PAGE_NUM; i++) {
		//设置为页开始地址
		oled_set_pos(0, i);
		//对该页的所有列填充该字节数据
		for (j = 0; j < OLED_WIDTH; j++) {
			oled_write_data(data);
		}
	}
}

//==========================================================================
//函数名称: oled_display_str
//函数返回: 无
//参数说明: col:起始列号，取值范围为[0,OLED_WIDTH-8]，这里为[0,120]
//         page:起始页号，取值范围为[0,OLED_PAGE_NUM-1]，这里为[0,7]
//         str:显示字符串的首地址
//功能概要: 从起始位置开始，显示一个以'\0'结束的字符串
//备注: 仅支持ASCII码字符集的可显示字符;
//     字符大小为8*16，一个字符占用8列、2页;
//     当字符串到达右边界时，会换行至下两页继续显示，
//     当字符串到达下边界时，会换行至第一页继续显示;
//     寻址方式需为按页寻址
//==========================================================================
void oled_display_str(uint8 col, uint8 page, uint8* str) {
	uint8 i, j;		//游标
	uint8 x, y;		//当前坐标
	uint8 index;	//该字符在字符库的索引

	//设置起始低页位置
	oled_set_pos(col, page);
	//填充低页字符数据
	for (i = 0, x = col, y = page; str[i] != '\0'; i++, x += 8) {
		//获取该字符的字符库索引
		index = str[i] - ' ';
		//当前横坐标越界时，换行
		if (x > OLED_WIDTH - 8) {
			x = 0;
			y += 2;
			//当前纵坐标越界时，换行
			if (y >= OLED_PAGE_NUM) {
				y -= OLED_PAGE_NUM;
			}
			//设置当前位置
			oled_set_pos(x, y);
		}
		//填充该字符数据
		for (j = 0; j < 8; j++) {
			oled_write_data(char_lib[index][j]);
		}
	}
	//切换为高页地址，若高页地址越界，换行
	if (++page >= OLED_PAGE_NUM) {
		page -= OLED_PAGE_NUM;
	}
	//设置起始高页位置
	oled_set_pos(col, page);
	//填充高页字符数据
	for (i = 0, x = col, y = page; str[i] != '\0'; i++, x += 8) {
		//获取该字符的字符库索引
		index = str[i] - ' ';
		//当前横坐标越界时，换行
		if (x > OLED_WIDTH - 8) {
			x = 0;
			y += 2;
			//当前纵坐标越界时，换行
			if (y >= OLED_PAGE_NUM) {
				y -= OLED_PAGE_NUM;
			}
			//设置当前位置
			oled_set_pos(x, y);
		}
		//填充该字符数据
		for (j = 8; j < 16; j++) {
			oled_write_data(char_lib[index][j]);
		}
	}
}

//==========================================================================
//函数名称: oled_printf
//函数返回: 显示的字符数，若小于0，说明内存不足，显示失败
//参数说明: col:起始列号，取值范围为[0,OLED_WIDTH-8]，这里为[0,120]
//         page:起始页号，取值范围为[0,OLED_PAGE_NUM-1]，这里为[0,7]
//         fmt:格式控制字符串，用法同标准printf
//         ...:可变参数，类型需与格式控制字符串一致
//功能概要: 从起始位置开始，显示格式化后的字符串
//备注: 仅支持ASCII码字符集的可显示字符;
//     字符大小为8*16，一个字符占用8列、2页;
//     当字符串到达右边界时，会换行至下两页继续显示，
//     当字符串到达下边界时，会换行至第一页继续显示;
//     寻址方式需为按页寻址;
//     若要支持浮点数的格式化，编译时需添加-u _printf_float选项
//==========================================================================
int32 oled_printf(uint8 col, uint8 page, uint8* fmt, ...) {
	va_list arg;	//指向可变参数的指针
	int32 result;	//显示的字符数
	char* ptr;		//指向格式化后的字符串的指针

	//获取可变参数列表的第一个参数的地址
	va_start(arg, fmt);
	//调用vasprintf，动态申请内存，格式化字符串，并将结果保存至ptr
	result = vasprintf(&ptr, fmt, arg);
	//结果大于等于0时，说明格式化成功
	if (result >= 0) {
		//显示格式化后的字符串
		oled_display_str(col, page, ptr);
		//释放申请内存
		free(ptr);
	}
	//清空va_list可变参数列表
	va_end(arg);
	//返回显示的字符数
	return result;
}

//==========================================================================
//函数名称: oled_set_contrast
//函数返回: 无
//参数说明: contrast:对比度值，取值范围为[0,255]，复位值为127
//功能概要: 设置OLED对比度，值越大，屏幕越亮
//==========================================================================
void oled_set_contrast(uint8 contrast) {
	//写设置对比度命令
	oled_write_cmd(0x81);
	//写对比度值
	oled_write_cmd(contrast);
}

//==========================================================================
//函数名称: oled_set_entire_display
//函数返回: 无
//参数说明: on:是否开启全部显示:
//            true: 开启全部显示;
//            false:关闭全部显示;
//            复位值为false
//功能概要: 设置是否开启全部显示
//备注: 开启全部显示时，整个屏幕为亮，关闭全部显示时，按照写入数据显示亮暗，
//     且数据不会因开启全部显示而丢失
//==========================================================================
void oled_set_entire_display(bool on) {
	if (on) {
		//全部显示
		oled_write_cmd(0xA5);
	} else {
		//正常显示
		oled_write_cmd(0xA4);
	}
}

//==========================================================================
//函数名称: oled_set_inverse_display
//函数返回: 无
//参数说明: on:是否开启反相显示:
//            true: 开启反相显示;
//            false:关闭反相显示;
//            复位值为false
//功能概要: 设置是否开启反相显示
//备注: 开启反相显示时，数据0代表亮，1代表暗，关闭反相显示时，数据0代表暗，1代表亮
//==========================================================================
void oled_set_inverse_display(bool on) {
	if (on) {
		//反相显示，数据0代表亮，1代表暗
		oled_write_cmd(0xA7);
	} else {
		//正常显示，数据0代表暗，1代表亮
		oled_write_cmd(0xA6);
	}
}

//==========================================================================
//函数名称: oled_set_display_on
//函数返回: 无
//参数说明: on:是否打开显示:
//            true: 打开显示;
//            false:关闭显示;
//            复位值为false
//功能概要: 设置是否打开显示
//备注: 打开显示时，按照写入数据显示亮暗，关闭显示时，整个屏幕为暗，
//     且数据不会因关闭显示而丢失
//==========================================================================
void oled_set_display_on(bool on) {
	if (on) {
		//打开显示
		oled_write_cmd(0xAF);
	} else {
		//关闭显示
		oled_write_cmd(0xAE);
	}
}

//==========================================================================
//函数名称: oled_set_scroll
//函数返回: 无
//参数说明: dir:水平滚动方向:
//             OLED_SCROLL_DIR_LEFT: 向左滚动;
//             OLED_SCROLL_DIR_RIGHT:向右滚动;
//         start_page:起始滚动页号，取值范围为[0,OLED_PAGE_NUM-1]，这里为[0,7]
//         end_page:结束滚动页号，取值范围为[start_page,OLED_PAGE_NUM-1]，
//                  这里为[start_page,7]
//         interval:滚动间隔:
//                  OLED_SCROLL_INTERVAL_FRAMES_x，每隔x帧滚动一次，x可取值为:
//                  2 | 3 | 4 | 5 | 25 | 64 | 128 | 256
//功能概要: 设置屏幕水平滚动配置
//备注: 起始滚动页和结束滚动页也会滚动;
//     需写开始滚动命令后，才会滚动;
//     屏幕刷新频率越高，一帧的时间越短
//==========================================================================
void oled_set_scroll(uint8 dir, uint8 start_page, uint8 end_page,
		uint8 interval) {
	if (dir == OLED_SCROLL_DIR_LEFT) {
		//向左水平滚动
		oled_write_cmd(0x27);
	} else {
		//向右水平滚动
		oled_write_cmd(0x26);
	}
	//无效字节
	oled_write_cmd(0x00);
	//发送起始页
	oled_write_cmd(start_page);
	//发送间隔频率
	oled_write_cmd(interval);
	//发送结束页
	oled_write_cmd(end_page);
	//无效字节
	oled_write_cmd(0x00);
	//无效字节
	oled_write_cmd(0xFF);
}

//==========================================================================
//函数名称: oled_set_scroll_with_vertical
//函数返回: 无
//参数说明: dir:水平滚动方向:
//             OLED_SCROLL_DIR_LEFT: 向左滚动;
//             OLED_SCROLL_DIR_RIGHT:向右滚动;
//         start_page:水平滚动起始页号，取值范围为[0,OLED_PAGE_NUM-1]，这里为[0,7]
//         end_page:水平滚动结束页号，取值范围为[start_page,OLED_PAGE_NUM-1]，
//                  这里为[start_page,7]
//         interval:滚动间隔:
//                  OLED_SCROLL_INTERVAL_FRAMES_x，每隔x帧滚动一次，x可取值为:
//                  2 | 3 | 4 | 5 | 25 | 64 | 128 | 256
//         fixed_row_num:从第一行起，不参与垂直滚动的行数，取值范围为[0,MUX]
//         scroll_row_num:从不参与垂直滚动的最后一行的下一行起，参与垂直滚动的行数，
//                        取值范围为[0,MUX-fixed_row_num]
//         offset_row_num:每次垂直滚动时偏移行数，取值范围为[0,scroll_row_num)
//功能概要: 设置屏幕水平和垂直滚动配置
//备注: 起始滚动页和结束滚动页也会滚动;
//     需写开始滚动命令后，才会滚动;
//     屏幕刷新频率越高，一帧的时间越短;
//     MUX为复用率，即可显示的行数，复位值为64;
//     垂直滚动方向为由上至下滚动，但上下反置后，为由下至上滚动;
//     水平和垂直滚动单独设置，两者可交叉，即一区域可同时水平和垂直滚动
//==========================================================================
void oled_set_scroll_with_vertical(uint8 dir, uint8 start_page, uint8 end_page,
		uint8 interval, uint8 fixed_row_num, uint8 scroll_row_num,
		uint8 offset_row_num) {
	//写设置垂直滚动区域命令
	oled_write_cmd(0xA3);
	//发送不参与垂直滚动的行数
	oled_write_cmd(fixed_row_num);
	//发送参与垂直滚动的行数
	oled_write_cmd(scroll_row_num);
	if (dir == OLED_SCROLL_DIR_LEFT) {
		//向左水平滚动
		oled_write_cmd(0x2A);
	} else {
		//向右水平滚动
		oled_write_cmd(0x29);
	}
	//无效字节
	oled_write_cmd(0x00);
	//发送起始页
	oled_write_cmd(start_page);
	//发送间隔频率
	oled_write_cmd(interval);
	//发送结束页
	oled_write_cmd(end_page);
	//发送每次垂直滚动偏移行数
	oled_write_cmd(offset_row_num);
}

//==========================================================================
//函数名称: oled_scroll_start
//函数返回: 无
//参数说明: 无
//功能概要: 写开始滚动命令
//备注: 需要预先设置好屏幕滚动配置和显示的内容
//==========================================================================
void oled_scroll_start() {
	//写开始滚动命令
	oled_write_cmd(0x2F);
}

//==========================================================================
//函数名称: oled_scroll_stop
//函数返回: 无
//参数说明: 无
//功能概要: 写停止滚动命令
//备注: 停止滚动后，垂直滚动的行会回归至原先的位置，但水平滚动的列会停止在当前所在位置
//==========================================================================
void oled_scroll_stop() {
	//写停止滚动命令
	oled_write_cmd(0x2E);
}

//==========================================================================
//函数名称: oled_set_addressing_mode
//函数返回: 无
//参数说明: mode:寻址方式:
//              OLED_ADDRESSING_MODE_HORIZONTAL:水平寻址;
//              OLED_ADDRESSING_MODE_VERTICAL:  垂直寻址;
//              OLED_ADDRESSING_MODE_PAGE:      按页寻址;
//              复位值为OLED_ADDRESSING_MODE_PAGE
//功能概要: 设置寻址方式
//备注: 水平寻址时，写一次数据后，列地址加一，如果列地址到达列的结束地址，
//     重置为开始地址，且页地址加一，如果列和页地址都到达结束地址，全部重置为开始地址;
//
//     垂直寻址时，写一次数据后，页地址加一，如果页地址到达页的结束地址，
//     重置为开始地址，且列地址加一，如果列和页地址都到达结束地址，全部重置为开始地址;
//
//     按页寻址时，写一次数据后，列地址加一，如果列地址到达列的结束地址，
//     重置为开始地址，且页地址不变
//==========================================================================
void oled_set_addressing_mode(uint8 mode) {
	//写设置寻址方式命令
	oled_write_cmd(0x20);
	//发送寻址方式
	oled_write_cmd(mode);
}

//==========================================================================
//函数名称: oled_set_pos
//函数返回: 无
//参数说明: col:列号，取值范围为[0,OLED_WIDTH-1]，这里为[0,127]，复位值为0
//         page:页号，取值范围为[0,OLED_PAGE_NUM-1]，这里为[0,7]，复位值为0
//功能概要: 设置当前位置
//备注: 寻址方式需为按页寻址
//==========================================================================
void oled_set_pos(uint8 col, uint8 page) {
	//设置当前低列地址
	oled_write_cmd(col & 0xF);
	//设置当前高列地址
	oled_write_cmd(0x10 | (col >> 4));
	//设置当前页地址
	oled_write_cmd(0xB0 | page);
}

//==========================================================================
//函数名称: oled_set_address_range
//函数返回: 无
//参数说明: start_col:起始列号，取值范围为[0,OLED_WIDTH-1]，
//                   这里为[0,127]，复位值为0
//         end_col:结束列号，取值范围为[0,OLED_WIDTH-1]，
//                 这里为[0,127]，复位值为127
//         start_page:起始页号，取值范围为[0,OLED_PAGE_NUM-1]，
//                    这里为[0,7]，复位值为0
//         end_page:结束页号，取值范围为[0,OLED_PAGE_NUM-1]，
//                  这里为[0,7]，复位值为7
//功能概要: 设置地址范围
//备注: 寻址方式需为水平寻址或垂直寻址
//==========================================================================
void oled_set_address_range(uint8 start_col, uint8 end_col, uint8 start_page,
		uint8 end_page) {
	//写设置列地址命令
	oled_write_cmd(0x21);
	//发送起始列
	oled_write_cmd(start_col);
	//发送结束列
	oled_write_cmd(end_col);
	//写设置页地址命令
	oled_write_cmd(0x22);
	//发送起始页
	oled_write_cmd(start_page);
	//发送结束页
	oled_write_cmd(end_page);
}

//==========================================================================
//函数名称: oled_set_start_line
//函数返回: 无
//参数说明: row:起始线行号，取值范围为[0,OLED_HEIGHT-1]，这里为[0,63]，复位值为0
//功能概要: 设置起始线
//备注: 设置起始线后，会从该行起显示图像;
//     复用率不为64时，不显示的行不会偏移
//==========================================================================
void oled_set_start_line(uint8 row) {
	oled_write_cmd(0x40 | row);
}

//==========================================================================
//函数名称: oled_set_display_offset
//函数返回: 无
//参数说明: row:偏移后起始行号，取值范围为[0,OLED_HEIGHT-1]，
//             这里为[0,63]，复位值为0
//功能概要: 设置显示偏移
//备注: 设置显示偏移后，会从偏移后起始行号起显示图像;
//     复用率不为64时，不显示的行也会偏移
//==========================================================================
void oled_set_display_offset(uint8 row) {
	//写设置显示偏移命令
	oled_write_cmd(0xD3);
	//发送偏移行数
	oled_write_cmd(row);
}

//==========================================================================
//函数名称: oled_set_multiplex_ratio
//函数返回: 无
//参数说明: multiplex_ratio:复用率，取值范围为[16,OLED_HEIGHT]，
//                         这里为[16,64]，复位值为64
//功能概要: 设置复用率，即可显示的行数
//备注: 复用率越高，屏幕刷新频率越低
//==========================================================================
void oled_set_multiplex_ratio(uint8 multiplex_ratio) {
	//写设置复用率命令
	oled_write_cmd(0xA8);
	//发送复用率
	oled_write_cmd(multiplex_ratio - 1);
}

//==========================================================================
//函数名称: oled_set_remap
//函数返回: 无
//参数说明: row_remap:是否启用行重映射:
//                   true:左右反置;
//                   false:正常显示;
//                   复位值为false
//         col_remap:是否启用列重映射:
//                   true:上下反置;
//                   false:正常显示;
//                   复位值为false
//功能概要: 设置重映射
//==========================================================================
void oled_set_remap(bool row_remap, bool col_remap) {
	if (row_remap) {
		//左右反置
		oled_write_cmd(0xA1);
	} else {
		//正常显示
		oled_write_cmd(0xA0);
	}
	if (col_remap) {
		//上下反置
		oled_write_cmd(0xC8);
	} else {
		//正常显示
		oled_write_cmd(0xC0);
	}
}

//==========================================================================
//函数名称: oled_set_com_pin_config
//函数返回: 无
//参数说明: order:COM引脚映射的顺序:
//               OLED_COM_PIN_CONFIG_SEQUENTIAL: 按顺序映射;
//               OLED_COM_PIN_CONFIG_ALTERNATIVE:交替映射;
//               复位值为OLED_COM_PIN_CONFIG_ALTERNATIVE
//         remap:COM0-COM31和COM32-COM63交换映射是否使能:
//               OLED_COM_PIN_CONFIG_REMAP_ENABLE: 使能交换映射;
//               OLED_COM_PIN_CONFIG_REMAP_DISABLE:关闭交换映射;
//               复位值为OLED_COM_PIN_CONFIG_REMAP_DISABLE
//功能概要: 设置COMx引脚到各行的映射配置
//备注: 按顺序映射时，COM0对应ROW0，COM1对应ROW1，以此类推;
//     交替映射时，COM0对应ROW0，COM32对应ROW1，COM1对应ROW2，COM33对应ROW3，
//     以此类推;
//     使能交换映射后，COM0和COM32对应行交换，COM1和COM33对应行交换，以此类推
//==========================================================================
void oled_set_com_pin_config(uint8 order, uint8 remap) {
	//写设置引脚命令
	oled_write_cmd(0xDA);
	//发送引脚设置
	oled_write_cmd(0x20 | order | remap);
}

//==========================================================================
//函数名称: oled_set_display_clk
//函数返回: 无
//参数说明: oscillator_freq:振荡器频率，取值范围为[0,15]，复位值为8
//         divide_ratio:显示时钟分频率，取值范围为[1,16]，复位值为1
//功能概要: 设置振荡器频率和显示时钟分频率
//备注: 振荡器频率越高，屏幕刷新频率越高，显示时钟分频率越高，屏幕刷新频率越低;
//     振荡器频率被显示时钟分频率分频后，得到显示时钟周期(DCLK)
//==========================================================================
void oled_set_display_clk(uint8 oscillator_freq, uint8 divide_ratio) {
	//写设置显示时钟命令
	oled_write_cmd(0xD5);
	//发送振荡频率和时钟分频率
	oled_write_cmd((divide_ratio - 1) | (oscillator_freq << 4));
}

//==========================================================================
//函数名称: oled_set_precharge_period
//函数返回: 无
//参数说明: phase1:阶段1预充电周期，取值范围为[1,15]，复位值为2
//         phase2:阶段2预充电周期，取值范围为[1,15]，复位值为2
//功能概要: 设置预充电周期，单位为显示时钟周期(DCLK)
//备注: 预充电周期越长，屏幕刷新频率越低
//==========================================================================
void oled_set_precharge_period(uint8 phase1, uint8 phase2) {
	//写设置预充电周期命令
	oled_write_cmd(0xD9);
	//发送阶段1和阶段2的预充电周期
	oled_write_cmd(phase1 | (phase2 << 4));
}

//==========================================================================
//函数名称: oled_set_vcomh
//函数返回: 无
//参数说明: vcomh:VCOMH引脚的电压:
//               OLED_VCOMH_065:0.65*VCC;
//               OLED_VCOMH_077:0.77*VCC;
//               OLED_VCOMH_083:0.83*VCC;
//               复位值为OLED_VCOMH_077
//功能概要: 设置VCOMH引脚的电压
//==========================================================================
void oled_set_vcomh(uint8 vcomh) {
	//写设置VCOMH命令
	oled_write_cmd(0xDB);
	//发送VCOMH
	oled_write_cmd(vcomh);
}

//==========================================================================
//函数名称: oled_set_charge_pump
//函数返回: 无
//参数说明: on:是否使能电荷泵:
//            true: 使能电荷泵;
//            false:关闭电荷泵;
//            复位值为false
//功能概要: 设置电荷泵是否使能
//备注: 必须使能电荷泵，屏幕才可以显示
//==========================================================================
void oled_set_charge_pump(bool on) {
	//写设置电荷泵命令
	oled_write_cmd(0x8D);
	if (on) {
		//使能电荷泵
		oled_write_cmd(0x14);
	} else {
		//关闭电荷泵
		oled_write_cmd(0x10);
	}
}

//==========================================================================
//函数名称: oled_nop
//函数返回: 无
//参数说明: 无
//功能概要: 进行一次空操作
//==========================================================================
void oled_nop() {
	//进行一次空操作
	oled_write_cmd(0xE3);
}
